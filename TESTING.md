Testing
=======

Most packages have up to four common sets of tests. A package called
`Foo` might have:

- `Foo.Tests`: unit tests. These should run quickly, in most cases without
  an internet connection being required.
- `Foo.IntegrationTests`: integration tests. These check that our
  packages work correctly with the real API.
- `Foo.Snippets`: documentation snippets, written and executed as
  tests. These often double up as integration tests. (If a snippet can
  test everything you need to know about a call, there's no point in
  also having an integration test.) For gRPC APIs, this project
  contains autogenerated as well as handwritten code; the
  autogenerated code is only used for documentation.
- `Foo.SmokeTests`: autogenerated tests that ensure we can at least
  contact the relevant API.

The test types other than unit tests require:

- An internet connection
- A Google Cloud Platform project
- Billing enabled
- The APIs you're testing enabled
- Common environment variables set as described below
- Per-API configuration as shown later, in some cases

**Running these tests can cost you money. They execute against
paid-for Google services.** They can also produce significant chunks of
network traffic - particularly some of the integration tests. You're
not recommended to run them against a mobile internet connection
unless you're sure you know what you're doing.

**These tests could destroy data in the projects they run in, or
leave test data afterwards.** Most tests create data in a
well-partitioned way and clean up after themselves, but there could
be a bug in a test which wipes all the data in the project. It is
*very strongly* recommended that you only run tests against projects
which do not contain any production data or services.

Running tests
=============

The `build.sh` script will run unit tests, and
`runintegrationtests.sh` will run integration tests and snippets.
(TODO: smoke tests too...) Consult the scripts for details on how to
run.

Additionally, you can just use `dotnet test` in any test project,
optionally specifying a test filter and/or target framework.

Common environment variables
============================

To run the integration/smoke tests or snippets, set the following
environment variables:

- `TEST_PROJECT`: The name of the Google Cloud Project to test against
- `GOOGLE_APPLICATION_CREDENTIALS`: The absolute path to a JSON file
  containing service credentials for the test project.

Per API configuration
=====================

Some APIs require a little more setup. If you're not testing an API
listed below, the instructions above should be all you need.

Google.Cloud.Bigtable.V2 and Google.Cloud.Bigtable.Admin.V2
-----------------------------------------------------------

The Bigtable integration tests can be run against the production
service or the emulator.

Running in production requires:

- A Bigtable instance, preferably of type Development, created within the
  project and identified by the `BIGTABLE_TEST_INSTANCE` environment variable
- The account identified in your service account JSON file to have read/write
  access to the project, including the IAM permissions in the Bigtable Administrator role

Running against the emulator requires:

- A running emulator on the local machine, started by using the
  `gcloud beta emulators bigtable start` command
- The `BIGTABLE_EMULATOR_HOST` environment variable set to `localhost:8086`

Currently there are no runnable snippets, but when they are added, they will
have the same requirements.

Google.Cloud.Firestore
----------------------

Firestore cannot currently operate on a Google Cloud project that also has a
Datastore database. You will need a second project:

- Create a project on the [Firebase Console](https://console.firebase.google.com/)
- Enable Firestore on that project (within the Firebase Console)
- Set the `FIRESTORE_TEST_PROJECT` environment variable with that
  project ID
- Add the account identified in your service account JSON file as an
  owner of the project, or download the service account JSON file for
  the Firestore project, and change the `GOOGLE_APPLICATION_CREDENTIALS`
  environment variable when you want to run the Firestore tests.

Google.Cloud.Storage.V1
-----------------------

- Enable the Google Cloud Pub/Sub API as well as Google Cloud Storage
